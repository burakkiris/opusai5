<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionQC | Akıllı Kalite Kontrol Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .animate-pulse-slow { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .slide-in { animation: slideIn 0.3s ease-out; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900">
    
    <!-- Header -->
    <header class="bg-slate-800/50 backdrop-blur-sm border-b border-slate-700">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                        <i data-lucide="target" class="w-6 h-6 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-white">VisionQC</h1>
                        <p class="text-sm text-slate-400">Yapay Zeka Destekli Kalite Kontrol</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-slate-400 text-sm hidden md:block">Problem 1: Ölçüsel Sapmaların Gözden Kaçması</span>
                    <span id="systemStatus" class="px-3 py-1 bg-green-500/20 text-green-400 rounded-full text-sm flex items-center gap-1">
                        <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                        Sistem Aktif
                    </span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-4 border border-slate-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-400 text-sm">Toplam Kontrol</p>
                        <p id="statTotal" class="text-3xl font-bold text-white">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center">
                        <i data-lucide="bar-chart-3" class="w-6 h-6 text-blue-400"></i>
                    </div>
                </div>
            </div>

            <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-4 border border-slate-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-400 text-sm">Geçti</p>
                        <p id="statPassed" class="text-3xl font-bold text-green-400">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center">
                        <i data-lucide="check-circle" class="w-6 h-6 text-green-400"></i>
                    </div>
                </div>
            </div>

            <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-4 border border-slate-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-400 text-sm">Kaldı</p>
                        <p id="statFailed" class="text-3xl font-bold text-red-400">0</p>
                    </div>
                    <div class="w-12 h-12 bg-red-500/20 rounded-lg flex items-center justify-center">
                        <i data-lucide="x-circle" class="w-6 h-6 text-red-400"></i>
                    </div>
                </div>
            </div>

            <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-4 border border-slate-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-400 text-sm">Başarı Oranı</p>
                        <p id="statRate" class="text-3xl font-bold text-white">0%</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center">
                        <i data-lucide="trending-up" class="w-6 h-6 text-purple-400"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Control Panel -->
            <div class="lg:col-span-1 space-y-4">
                <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-5 border border-slate-700">
                    <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                        <i data-lucide="package" class="w-5 h-5 text-blue-400"></i>
                        Kontrol Paneli
                    </h2>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">Ürün Seçimi</label>
                            <select id="productSelect" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="FRC-180-STD">FRC-180-STD - Doku Forsepsi Standart</option>
                                <option value="SCR-120-PRO">SCR-120-PRO - Cerrahi Makas Pro</option>
                                <option value="CLM-090-ECO">CLM-090-ECO - Klemp Ekonomik</option>
                                <option value="RTR-150-MED">RTR-150-MED - Retraktör Medikal</option>
                                <option value="NHD-080-PRE">NHD-080-PRE - İğne Tutucu Presizyon</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="runSingleTest()" id="btnSingle" class="flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 text-white font-medium py-2.5 px-4 rounded-lg transition-colors">
                                <i data-lucide="zap" class="w-4 h-4"></i>
                                Tek Kontrol
                            </button>
                            <button onclick="toggleAutoMode()" id="btnAuto" class="flex items-center justify-center gap-2 bg-slate-700 hover:bg-slate-600 text-white font-medium py-2.5 px-4 rounded-lg transition-colors">
                                <i data-lucide="play" class="w-4 h-4"></i>
                                Oto Mod
                            </button>
                        </div>

                        <button onclick="runBatchTest()" id="btnBatch" class="w-full flex items-center justify-center gap-2 bg-purple-600 hover:bg-purple-700 disabled:opacity-50 text-white font-medium py-2.5 px-4 rounded-lg transition-colors">
                            <i data-lucide="activity" class="w-4 h-4"></i>
                            Toplu Simülasyon (25 Ürün)
                        </button>

                        <button onclick="clearHistory()" class="w-full flex items-center justify-center gap-2 bg-slate-700 hover:bg-slate-600 text-slate-300 font-medium py-2.5 px-4 rounded-lg transition-colors">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            Geçmişi Temizle
                        </button>
                    </div>
                </div>

                <!-- Product Specs -->
                <div id="productSpecs" class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-5 border border-slate-700">
                    <h3 class="text-lg font-semibold text-white mb-3 flex items-center gap-2">
                        <i data-lucide="shield" class="w-5 h-5 text-green-400"></i>
                        Ürün Spesifikasyonu
                    </h3>
                    <p id="specName" class="text-sm text-slate-400 mb-3">Doku Forsepsi Standart</p>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div class="bg-slate-700/50 rounded-lg p-2">
                            <p class="text-xs text-slate-400">Uzunluk</p>
                            <p id="specLength" class="text-white font-semibold">180mm</p>
                            <p id="specLengthTol" class="text-xs text-blue-400">±1.0</p>
                        </div>
                        <div class="bg-slate-700/50 rounded-lg p-2">
                            <p class="text-xs text-slate-400">Genişlik</p>
                            <p id="specWidth" class="text-white font-semibold">12mm</p>
                            <p id="specWidthTol" class="text-xs text-blue-400">±0.3</p>
                        </div>
                        <div class="bg-slate-700/50 rounded-lg p-2">
                            <p class="text-xs text-slate-400">Yükseklik</p>
                            <p id="specHeight" class="text-white font-semibold">8mm</p>
                            <p id="specHeightTol" class="text-xs text-blue-400">±0.2</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Last Result -->
            <div class="lg:col-span-1">
                <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-5 border border-slate-700 h-full">
                    <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                        <i data-lucide="activity" class="w-5 h-5 text-purple-400"></i>
                        Son Kontrol Sonucu
                    </h2>

                    <div id="lastResultEmpty" class="h-64 flex items-center justify-center text-slate-500">
                        <div class="text-center">
                            <i data-lucide="activity" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                            <p>Henüz kontrol yapılmadı</p>
                            <p class="text-sm">Başlamak için "Tek Kontrol" butonuna tıklayın</p>
                        </div>
                    </div>

                    <div id="lastResultContent" class="hidden space-y-4">
                        <div id="resultStatus" class="text-center py-6 rounded-xl bg-green-500/20">
                            <div id="resultStatusText" class="text-5xl font-bold text-green-500">GEÇTİ</div>
                            <p id="resultConfidence" class="text-slate-400 mt-2">Güven: %98.5</p>
                        </div>

                        <div class="bg-slate-700/30 rounded-lg p-4">
                            <p id="resultProductName" class="text-sm text-slate-400 mb-2">Ürün: Doku Forsepsi</p>
                            <p id="resultProductCode" class="text-sm text-slate-400 mb-3">Kod: FRC-180-STD</p>
                            
                            <div id="measurementDetails" class="space-y-2">
                                <!-- Measurements will be inserted here -->
                            </div>
                        </div>

                        <div class="flex items-center justify-between text-sm text-slate-400">
                            <span id="resultTime" class="flex items-center gap-1">
                                <i data-lucide="clock" class="w-4 h-4"></i>
                                250ms
                            </span>
                            <span id="resultTimestamp">14:32:15</span>
                        </div>

                        <div id="issuesContainer" class="hidden bg-red-500/10 border border-red-500/30 rounded-lg p-3">
                            <p class="text-red-400 text-sm font-medium flex items-center gap-1 mb-1">
                                <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                                Tespit Edilen Sorunlar
                            </p>
                            <ul id="issuesList" class="text-sm text-red-300 space-y-1">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Inspections -->
            <div class="lg:col-span-1">
                <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl p-5 border border-slate-700 h-full">
                    <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                        <i data-lucide="clock" class="w-5 h-5 text-orange-400"></i>
                        Son Kontroller
                    </h2>

                    <div id="recentInspections" class="space-y-2 max-h-[500px] overflow-y-auto pr-2">
                        <div class="h-32 flex items-center justify-center text-slate-500">
                            <p>Kontrol geçmişi boş</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-6 text-center text-slate-500 text-sm">
            <p>VisionQC Demo - Yapay Zeka ile Yerel Dönüşüm Atölyesi 2025</p>
            <p class="mt-1">Problem 1: Ölçüsel Sapmaların Gözden Kaçması - Machine Vision Çözüm Prototipi</p>
        </div>
    </main>

    <script>
        const API_URL = 'http://localhost:8000';
        let autoModeInterval = null;
        let isAutoMode = false;

        const PRODUCT_SPECS = {
            'FRC-180-STD': { name: 'Doku Forsepsi Standart', nominal: { length: 180, width: 12, height: 8 }, tolerance: { length: 1.0, width: 0.3, height: 0.2 } },
            'SCR-120-PRO': { name: 'Cerrahi Makas Pro', nominal: { length: 120, width: 15, height: 6 }, tolerance: { length: 0.8, width: 0.4, height: 0.3 } },
            'CLM-090-ECO': { name: 'Klemp Ekonomik', nominal: { length: 90, width: 8, height: 5 }, tolerance: { length: 0.5, width: 0.2, height: 0.15 } },
            'RTR-150-MED': { name: 'Retraktör Medikal', nominal: { length: 150, width: 20, height: 10 }, tolerance: { length: 1.2, width: 0.5, height: 0.4 } },
            'NHD-080-PRE': { name: 'İğne Tutucu Presizyon', nominal: { length: 80, width: 6, height: 4 }, tolerance: { length: 0.3, width: 0.15, height: 0.1 } }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            updateProductSpecs();
            fetchDashboard();
        });

        document.getElementById('productSelect').addEventListener('change', updateProductSpecs);

        function updateProductSpecs() {
            const code = document.getElementById('productSelect').value;
            const spec = PRODUCT_SPECS[code];
            document.getElementById('specName').textContent = spec.name;
            document.getElementById('specLength').textContent = spec.nominal.length + 'mm';
            document.getElementById('specWidth').textContent = spec.nominal.width + 'mm';
            document.getElementById('specHeight').textContent = spec.nominal.height + 'mm';
            document.getElementById('specLengthTol').textContent = '±' + spec.tolerance.length;
            document.getElementById('specWidthTol').textContent = '±' + spec.tolerance.width;
            document.getElementById('specHeightTol').textContent = '±' + spec.tolerance.height;
        }

        async function fetchDashboard() {
            try {
                const res = await fetch(`${API_URL}/dashboard`);
                const data = await res.json();
                updateStats(data);
                updateRecentInspections(data.recent_inspections || []);
            } catch (error) {
                console.error('Dashboard yüklenemedi:', error);
            }
        }

        function updateStats(data) {
            document.getElementById('statTotal').textContent = data.total_inspections || 0;
            document.getElementById('statPassed').textContent = data.passed || 0;
            document.getElementById('statFailed').textContent = data.failed || 0;
            document.getElementById('statRate').textContent = (data.pass_rate || 0).toFixed(1) + '%';
        }

        function updateRecentInspections(inspections) {
            const container = document.getElementById('recentInspections');
            if (inspections.length === 0) {
                container.innerHTML = '<div class="h-32 flex items-center justify-center text-slate-500"><p>Kontrol geçmişi boş</p></div>';
                return;
            }

            container.innerHTML = inspections.slice(0, 20).map(i => `
                <div class="flex items-center justify-between bg-slate-700/30 rounded-lg p-3 hover:bg-slate-700/50 transition-colors slide-in">
                    <div class="flex items-center gap-3">
                        <div class="w-3 h-3 rounded-full ${i.status === 'PASSED' ? 'bg-green-500' : 'bg-red-500'}"></div>
                        <div>
                            <p class="text-white text-sm font-medium">${i.product_code}</p>
                            <p class="text-slate-400 text-xs">${new Date(i.timestamp).toLocaleTimeString('tr-TR')}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-semibold ${i.status === 'PASSED' ? 'text-green-500' : 'text-red-500'}">
                            ${i.status === 'PASSED' ? 'GEÇTİ' : 'KALDI'}
                        </p>
                        <p class="text-xs text-slate-400">${i.processing_time_ms}ms</p>
                    </div>
                </div>
            `).join('');
        }

        function updateLastResult(result) {
            document.getElementById('lastResultEmpty').classList.add('hidden');
            document.getElementById('lastResultContent').classList.remove('hidden');

            const isPassed = result.status === 'PASSED';
            const statusDiv = document.getElementById('resultStatus');
            statusDiv.className = `text-center py-6 rounded-xl ${isPassed ? 'bg-green-500/20' : 'bg-red-500/20'}`;
            
            document.getElementById('resultStatusText').textContent = isPassed ? 'GEÇTİ' : 'KALDI';
            document.getElementById('resultStatusText').className = `text-5xl font-bold ${isPassed ? 'text-green-500' : 'text-red-500'}`;
            document.getElementById('resultConfidence').textContent = `Güven: %${result.confidence}`;
            
            document.getElementById('resultProductName').textContent = `Ürün: ${result.product_name}`;
            document.getElementById('resultProductCode').textContent = `Kod: ${result.product_code}`;
            
            const dims = [
                { key: 'length', label: 'Uzunluk' },
                { key: 'width', label: 'Genişlik' },
                { key: 'height', label: 'Yükseklik' }
            ];
            
            document.getElementById('measurementDetails').innerHTML = dims.map(d => {
                const isOut = Math.abs(result.deviations[d.key]) > result.tolerance[d.key];
                return `
                    <div class="flex items-center justify-between p-2 rounded ${isOut ? 'bg-red-500/20' : 'bg-green-500/10'}">
                        <span class="text-slate-300">${d.label}</span>
                        <div class="text-right">
                            <span class="font-mono ${isOut ? 'text-red-400' : 'text-green-400'}">
                                ${result.measurements[d.key]}mm
                            </span>
                            <span class="text-xs text-slate-500 ml-2">
                                (${result.deviations[d.key] >= 0 ? '+' : ''}${result.deviations[d.key]})
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('resultTime').innerHTML = `<i data-lucide="clock" class="w-4 h-4"></i> ${result.processing_time_ms}ms`;
            document.getElementById('resultTimestamp').textContent = new Date(result.timestamp).toLocaleTimeString('tr-TR');
            
            if (result.issues && result.issues.length > 0) {
                document.getElementById('issuesContainer').classList.remove('hidden');
                document.getElementById('issuesList').innerHTML = result.issues.map(i => `<li>• ${i}</li>`).join('');
            } else {
                document.getElementById('issuesContainer').classList.add('hidden');
            }
            
            lucide.createIcons();
        }

        async function runSingleTest() {
            const code = document.getElementById('productSelect').value;
            const btn = document.getElementById('btnSingle');
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Kontrol...';
            
            try {
                const res = await fetch(`${API_URL}/simulate?product_code=${code}`, { method: 'POST' });
                const result = await res.json();
                updateLastResult(result);
                await fetchDashboard();
            } catch (error) {
                console.error('Kontrol hatası:', error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="zap" class="w-4 h-4"></i> Tek Kontrol';
                lucide.createIcons();
            }
        }

        function toggleAutoMode() {
            isAutoMode = !isAutoMode;
            const btn = document.getElementById('btnAuto');
            
            if (isAutoMode) {
                btn.className = 'flex items-center justify-center gap-2 bg-orange-600 hover:bg-orange-700 text-white font-medium py-2.5 px-4 rounded-lg transition-colors';
                btn.innerHTML = '<i data-lucide="pause" class="w-4 h-4"></i> Durdur';
                autoModeInterval = setInterval(runSingleTest, 1500);
            } else {
                btn.className = 'flex items-center justify-center gap-2 bg-slate-700 hover:bg-slate-600 text-white font-medium py-2.5 px-4 rounded-lg transition-colors';
                btn.innerHTML = '<i data-lucide="play" class="w-4 h-4"></i> Oto Mod';
                clearInterval(autoModeInterval);
            }
            lucide.createIcons();
        }

        async function runBatchTest() {
            const btn = document.getElementById('btnBatch');
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> İşleniyor...';
            
            try {
                await fetch(`${API_URL}/batch-simulate?count=25`, { method: 'POST' });
                await fetchDashboard();
            } catch (error) {
                console.error('Toplu simülasyon hatası:', error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="activity" class="w-4 h-4"></i> Toplu Simülasyon (25 Ürün)';
                lucide.createIcons();
            }
        }

        async function clearHistory() {
            try {
                await fetch(`${API_URL}/history`, { method: 'DELETE' });
                document.getElementById('lastResultEmpty').classList.remove('hidden');
                document.getElementById('lastResultContent').classList.add('hidden');
                await fetchDashboard();
            } catch (error) {
                console.error('Geçmiş temizlenemedi:', error);
            }
        }
    </script>
</body>
</html>
